$(document).on('turbolinks:load', function(){
  $('[data-channel-subscribe="game"]').each(function(index, element) {
    var $element = $(element),
      game_id = $element.data('game-id'),
      row = 1,
      column = 1;

    function setPieces() {
      let droppable = url => {
        $('.droppable').droppable({
          drop: e => {
            $.ajax({
              type: 'PUT',
              url: url,
              data: {
                row: $(e.target).data('row'),
                column: $(e.target).data('column'),
              },
            });
          },
        });
      };

      $('.draggable .piece').draggable({
        revert: 'invalid',
        revertDuration: 200,
        drag: e => {
          droppable($(e.target).data('url'));
        },
      });
    }

    setPieces();

    App.cable.subscriptions.create(
      {
        channel: 'GameChannel',
        id: game_id,
      },
      {
        received: function(data) {

          updateView(setPieces);

          function updateView(callback) {
            $('#game-box').html(data.view);
            callback();
          };
        },
      }
    );
  });
});
